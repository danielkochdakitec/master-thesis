\chapter{Firebase}

Das nächste Kapitel beschreibt die Architektur und die Implementierung der geplanten Anwendung mit Google Firebase.

\section{Architektur}

Für die Architektur wird zunächst die Lösungsstrategie vorgestellt. Darauf folgen die Bausteinsicht, die Laufzeitsicht sowie die Verteilungssicht.

\subsection{Lösungsstrategie}

Ebenfalls wie bei \ac{AWS} Amplify lässt sich die Architektur von Firebase in Präsentation, Logik und Datenhaltung aufteilen, welche durch unterschiedliche Cloud-Dienste und Frameworks abgebildet sind.
\begin{itemize}
  \item Präsentation
    \begin{itemize}
      \item React.js mit TypeScript
      \item Firebase Javascript SDK
    \end{itemize}
  \item Logik
    \begin{itemize}
      \item Authentication
      \item Cloud Functions
      \item Transcoder API
      \item IAM
    \end{itemize}
  \item Datenhaltung
    \begin{itemize}
      \item Authentication
      \item Cloud Firestore
      \item Cloud Storage
      \item IAM
      \item Firebase Hosting
    \end{itemize}
\end{itemize}

Die Dienste IAM und Authentication befindet sich zugleich in der Logik als auch in der Datenhaltung, da dort neben der Authentifizierung und Autorisierung auch die Benutzer persistiert werden.

Auch hier werden ausschließlich interne Dienste der Google Cloud verwendet, so dass die Rahmenbedingungen nicht missachtet sind und die beiden Technologien vergleichbar sind. Abgesehen von Cloud-Diensten ist der Unterschied beider Projekte auf technischer Ebene, dass die Firebase-Anwendung im Backend TypeScript statt JavaScript verwendet.

Als nächstes werden Lösungsansätze, um die nichtfunktionalen Anforderungen, auch Qualitätsziele genannt, zu erreichen:

\begin{description}
   \item[Verfügbarkeit] Firebase bietet für Frontend und Backend ein Zero-Downtime Deployment.
   \item[Skalierbarkeit] Durch die Serverless-Architektur skalieren Funktionen sowie Firestore automatisch innerhalb der Google-Cloud.
   \item[Analysierbarkeit] Durch den Einsatz von Cloud Logging können Anfragen für Funktionen nachvollzogen werden.
   \item[Interoperabilität] Es wird keine REST- oder GraphQL-Schnittstelle genutzt. Stattdessen werden die Funktionen des Backends direkt aufgerufen. Damit ist die Interoperabilität nicht direkt gegeben.
   \item[Backups] Backups lassen sich automatisiert über Firestore aktivieren.
   \item[Wiederherstellbarkeit] Das Backup von Firestore muss manuell eingespielt werden.
\end{description}

\subsection{Bausteinsicht}



\subsection{Laufzeitsicht}

Die Laufzeitsicht beschreibt die wichtigsten Prozesse und wie die Bausteine miteinander interagieren.

\subsubsection{Auflisten, Aktualisieren und Löschen eines Videos}

\begin{figure}
  \centering
  \includegraphics[width=1\columnwidth]{6_firebase/laufzeitsicht_1.pdf}
  \caption{Firebase - Laufzeitsicht - Lesen, Aktualisieren und Löschen eines Videos}
  \label{Firebase:laufzeitsicht1}
\end{figure}

\autoref{Firebase:laufzeitsicht1} stellt den Prozess, wie Videos von Nutzern aufgelistet, aktualisiert oder gelöscht werden, dar. Dieser wird im folgenden Abschnitt näher erläutert:

\begin{enumerate}
  \item{Der Nutzer stellt eine Anfrage mittels eines Funktionsaufrufs, der den JSON Webtoken und weitere Funktionsparameter mitsendet.}
  \item{Der Nutzer wird autorisiert und die Funktion wird mit einer Kontext-Variable, die den Nutzer enthält, ausgeführt. Die Funktion führt nun weitere Anfragen an Firestore und optional an Storage aus.}
  \item{Die Rechteprüfungen beim Aktualisieren oder Löschen des Videos werden selbst durchgeführt, indem eine Tabelle mit einer Liste aller Administratoren geholt wird.}
  \item{Handelt es sich um eine Anfrage zum Auflisten, werden aus der Video-Tabelle alle Datensätze unter Berücksichtigung des Suchfelds geholt. Bei den Abfragen zum Aktualisieren oder löschen prüft die Funktion das Besitzer-Attribut, wenn der Nutzer kein Administrator ist.}
  \item{Handelt es sich um eine Anfrage zum Auflisten, werden signierte temporäre Links über den Service Storage erstellt.}
\end{enumerate}

\subsubsection{Erstellen eines Videos}

\begin{figure}
  \centering
  \includegraphics[width=1\columnwidth]{6_firebase/laufzeitsicht_2.pdf}
  \caption{Firebase - Laufzeitsicht - Erstellen eines Videos}
  \label{Firebase:laufzeitsicht2}
\end{figure}

Functions:
- AddWaterMarkToVideo
- createVideo

0. Upload in firestore storage
1. Call to createVideo
2. Create video in firebase (with raw link to firestore)
3. Firestore Trigger executes on Create video/{docId}
4. Calls video-transcoder to add watermark, put in storage and put the new link in Firestore again


\subsection{Verteilungssicht}

\section{Implementierung}

todo